<mah:MetroWindow x:Class="EnhancedGameHub.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
        xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks"
        xmlns:viewModels="clr-namespace:EnhancedGameHub.ViewModels"
        xmlns:models="clr-namespace:EnhancedGameHub.Models"
        xmlns:converters="clr-namespace:EnhancedGameHub.Converters"
        mc:Ignorable="d"
        Title="Enhanced Game Hub" Height="720" Width="1280"
        GlowBrush="{DynamicResource MahApps.Brushes.Accent}"
        WindowStartupLocation="CenterScreen"
        WindowTransitionsEnabled="True"
        mah:DialogParticipation.Register="{Binding}">

    <mah:MetroWindow.DataContext>
        <viewModels:MainViewModel/>
    </mah:MetroWindow.DataContext>

    <mah:MetroWindow.Resources>
        <ResourceDictionary>
            <!-- FIX #2: Add the converter as a resource -->
            <converters:IntToVisibilityConverter x:Key="IntToVisibilityConverter"/>

            <DropShadowEffect x:Key="Card.Shadow" ShadowDepth="2" BlurRadius="10" Color="#000000" Opacity="0.4"/>
        </ResourceDictionary>
    </mah:MetroWindow.Resources>

    <!-- Flyout for adding a new game -->
    <mah:MetroWindow.Flyouts>
        <mah:FlyoutsControl>
            <mah:Flyout Header="Add a New Game" Position="Right" Width="350"
                        IsOpen="{Binding IsAddGameFlyoutOpen}"
                        Theme="Adapt">
                <Grid Margin="20">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <StackPanel Grid.Row="0" DataContext="{Binding NewGame}">
                        <TextBlock Text="Game Executable" FontWeight="Bold"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox Grid.Column="0" Text="{Binding ExecutablePath, Mode=OneWay}" IsReadOnly="True" VerticalAlignment="Center"/>
                            <Button Grid.Column="1" Content="Browse..." Command="{Binding DataContext.SelectNewGameExeCommand, RelativeSource={RelativeSource AncestorType=mah:Flyout}}" Margin="5,0,0,0"/>
                        </Grid>

                        <TextBlock Text="Title" FontWeight="Bold" Margin="0,15,0,0"/>
                        <TextBox Text="{Binding Title, UpdateSourceTrigger=PropertyChanged}"/>

                        <TextBlock Text="Category" FontWeight="Bold" Margin="0,15,0,0"/>
                        <ComboBox ItemsSource="{Binding DataContext.Categories, RelativeSource={RelativeSource AncestorType=mah:Flyout}}" 
                                  SelectedItem="{Binding Category}"
                                  DisplayMemberPath="."/>
                    </StackPanel>

                    <Button Grid.Row="2" Content="Save Game" 
                            Command="{Binding SaveNewGameCommand}"
                            Style="{StaticResource MahApps.Styles.Button.Square.Accent}" HorizontalAlignment="Stretch"/>
                </Grid>
            </mah:Flyout>
        </mah:FlyoutsControl>
    </mah:MetroWindow.Flyouts>

    <Grid>
        <Grid.Background>
            <SolidColorBrush Color="{DynamicResource MahApps.Colors.Gray10}"/>
        </Grid.Background>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Top Control Bar -->
        <Grid Grid.Row="0" Margin="10,10,10,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <Button Grid.Column="0" ToolTip="Add a new game"
                    Command="{Binding OpenAddGameFlyoutCommand}"
                    Style="{StaticResource MahApps.Styles.Button.Circle}"
                    Width="40" Height="40">
                <iconPacks:PackIconMaterial Kind="Plus" Width="20" Height="20" />
            </Button>

            <!-- FIX #1: Replace SearchBox with a styled TextBox -->
            <TextBox Grid.Column="1" Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                     mah:TextBoxHelper.Watermark="Search library..."
                     mah:TextBoxHelper.ClearTextButton="True"
                     VerticalAlignment="Center" Margin="20,0"
                     Style="{StaticResource MahApps.Styles.TextBox.Search}"/>

            <mah:ToggleSwitch Grid.Column="2" IsOn="{Binding IsDarkTheme, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                              OffContent="Light" OnContent="Dark" Toggled="ToggleSwitch_Toggled" VerticalAlignment="Center"/>
        </Grid>

        <!-- Games Grid -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled" Padding="15">
            <ItemsControl ItemsSource="{Binding FilteredGames}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="{x:Type models:Game}">
                        <Border x:Name="CardBorder" Width="220" Height="280" Margin="10" CornerRadius="8"
                                Effect="{StaticResource Card.Shadow}"
                                Background="{DynamicResource MahApps.Brushes.Gray9}">
                            <Grid>
                                <!-- Game Cover Art -->
                                <Border CornerRadius="8" ClipToBounds="True">
                                    <Image Source="{Binding CoverArt}" Stretch="UniformToFill"/>
                                </Border>

                                <!-- Title Overlay -->
                                <Border VerticalAlignment="Bottom" Height="60" CornerRadius="0,0,8,8">
                                    <Border.Background>
                                        <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                            <GradientStop Color="#00000000" Offset="0.0" />
                                            <GradientStop Color="#CC000000" Offset="1.0" />
                                        </LinearGradientBrush>
                                    </Border.Background>
                                    <StackPanel VerticalAlignment="Bottom" Margin="12">
                                        <TextBlock Text="{Binding Title}" FontWeight="Bold" FontSize="16" Foreground="White" TextTrimming="CharacterEllipsis"/>
                                        <TextBlock Text="{Binding Category}" FontSize="12" Foreground="{DynamicResource MahApps.Brushes.Gray4}"/>
                                    </StackPanel>
                                </Border>

                                <!-- Launch Button Overlay -->
                                <Grid x:Name="HoverOverlay" Background="#4C000000" Opacity="0">
                                    <Button Command="{Binding DataContext.LaunchGameCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                            CommandParameter="{Binding}"
                                            Style="{StaticResource MahApps.Styles.Button.Circle}"
                                            Width="60" Height="60"
                                            Background="{DynamicResource MahApps.Brushes.Accent}"
                                            BorderBrush="White" BorderThickness="2">
                                        <iconPacks:PackIconMaterial Kind="Play" Width="30" Height="30" Foreground="White"/>
                                    </Button>
                                </Grid>
                            </Grid>
                            <Border.ContextMenu>
                                <ContextMenu>
                                    <MenuItem Header="Launch Game" Command="{Binding DataContext.LaunchGameCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}" CommandParameter="{Binding}">
                                        <MenuItem.Icon>
                                            <iconPacks:PackIconMaterial Kind="Play"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <Separator/>
                                    <MenuItem Header="Change Executable..." Command="{Binding DataContext.SelectExeCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}" CommandParameter="{Binding}">
                                        <MenuItem.Icon>
                                            <iconPacks:PackIconMaterial Kind="FileCogOutline"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <MenuItem Header="Remove Game" Command="{Binding DataContext.RemoveGameCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}" CommandParameter="{Binding}">
                                        <MenuItem.Icon>
                                            <iconPacks:PackIconMaterial Kind="TrashCanOutline"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                </ContextMenu>
                            </Border.ContextMenu>
                        </Border>
                        <DataTemplate.Triggers>
                            <Trigger SourceName="CardBorder" Property="IsMouseOver" Value="True">
                                <!-- Using a storyboard for a smooth fade-in animation -->
                                <Trigger.EnterActions>
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <DoubleAnimation Storyboard.TargetName="HoverOverlay" Storyboard.TargetProperty="Opacity" To="1" Duration="0:0:0.2"/>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </Trigger.EnterActions>
                                <Trigger.ExitActions>
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <DoubleAnimation Storyboard.TargetName="HoverOverlay" Storyboard.TargetProperty="Opacity" To="0" Duration="0:0:0.3"/>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </Trigger.ExitActions>
                            </Trigger>
                        </DataTemplate.Triggers>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- "No Games Found" Message -->
        <TextBlock Grid.Row="1" Text="Your library is empty. Add a game to get started!" 
                   VerticalAlignment="Center" HorizontalAlignment="Center"
                   FontSize="18" Foreground="{DynamicResource MahApps.Brushes.Gray4}"
                   Visibility="{Binding FilteredGames.Count, Converter={StaticResource IntToVisibilityConverter}, ConverterParameter=inverse}"/>
    </Grid>
</mah:MetroWindow>